This code is based on https://github.com/iutinvg/compass/